<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coin Emir Derinliği Hesaplayıcı</title>
<style>
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
th {
    background-color: #f2f2f2;
    cursor: pointer;
}
#summary {
    margin-bottom: 20px;
}
</style>
</head>
<body>
<h1>Coin Emir Derinliği Hesaplayıcı</h1>
<label for="alertRatio">Alarm Oranı (Varsayılan 1.3):</label>
<input type="number" id="alertRatio" value="1.3" step="0.1">
<button onclick="startCalculations()">Başlat</button>
<div id="summary">
    <h2>Toplam Alış/Satış Özeti</h2>
    <p id="totalBuys">Toplam Alışlar: 0</p>
    <p id="totalSells">Toplam Satışlar: 0</p>
    <p id="ratio">Alış/Satış Oranı: 0</p>
</div>
<table id="resultTable">
<thead>
    <tr>
        <th onclick="sortTable(0)">Coin Çifti</th>
        <th onclick="sortTable(1)">Alış Toplamı</th>
        <th onclick="sortTable(2)">Satış Toplamı</th>
        <th onclick="sortTable(3)">Alış/Satış Oranı</th>
    </tr>
</thead>
<tbody>
</tbody>
</table>

<script>
const coins = ["BTCUSDT", "ETHUSDT", "BNBUSDT", "XRPUSDT", "ADAUSDT"];
let totalAsks = 0, totalBids = 0;
let intervalId = null;
let shortEma = null, longEma = null;

function getApiData(symbol, callback) {
    const url = `https://api.binance.com/api/v3/depth?symbol=${symbol}&limit=1000`;
    fetch(url)
    .then(response => response.json())
    .then(data => callback(null, data))
    .catch(error => callback(error, null));
}

function getCandleData(symbol, callback) {
    const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1m&limit=300`;
    fetch(url)
    .then(response => response.json())
    .then(data => callback(null, data))
    .catch(error => callback(error, null));
}

function calculateEMA(data, period) {
    const k = 2 / (period + 1);
    let emaArray = [];
    let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period; // İlk EMA değeri
    emaArray.push(ema);
    for (let i = period; i < data.length; i++) {
        ema = (data[i] - ema) * k + ema;
        emaArray.push(ema);
    }
    return emaArray;
}

function calculateAll() {
    const tbody = document.getElementById('resultTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = ''; // Tabloyu temizle
    totalAsks = 0; totalBids = 0; // Toplamları sıfırla

    coins.forEach(symbol => {
        getApiData(symbol, (err, data) => {
            if (err) {
                console.error('Error fetching data for', symbol, err);
                return;
            }

            const currentPrice = parseFloat(data.asks[0][0]);
            const upperLimit = currentPrice * 1.03;
            const lowerLimit = currentPrice * 0.97;
            let askSum = 0, bidSum = 0;

            data.asks.forEach(([price, amount]) => {
                if (parseFloat(price) <= upperLimit) askSum += parseFloat(amount); // Yukarıdan satmak isteyenler
            });
            data.bids.forEach(([price, amount]) => {
                if (parseFloat(price) >= lowerLimit) bidSum += parseFloat(amount); // Aşağıdan almak isteyenler
            });

            totalAsks += askSum;
            totalBids += bidSum;

            const ratio = (totalBids / totalAsks).toFixed(2);
            const row = tbody.insertRow();
            row.innerHTML = `<td>${symbol}</td><td>${askSum.toFixed(2)}</td><td>${bidSum.toFixed(2)}</td><td>${ratio}</td>`;

            document.getElementById('totalBuys').textContent = `Toplam Alışlar: ${totalBids.toFixed(2)}`;
            document.getElementById('totalSells').textContent = `Toplam Satışlar: ${totalAsks.toFixed(2)}`;
            document.getElementById('ratio').textContent = `Alış/Satış Oranı: ${ratio}`;

            if (symbol === "BTCUSDT") checkBTCConditions(ratio);
        });
    }); 
}

function checkBTCConditions(ratio) {
    const alarmRatio = parseFloat(document.getElementById('alertRatio').value);
    if (shortEma !== null && longEma !== null) {
        if (shortEma < longEma || ratio < alarmRatio) {
            const audio = new Audio('alarm.wav');
            audio.play();
        }
    }
}

function calculateBTCEMAs() {
    getCandleData("BTCUSDT", (err, data) => {
        if (err) {
            console.error('Error fetching BTC data', err);
            return;
        }

        const closePrices = data.map(candle => parseFloat(candle[4]));
        const threeMinuteData = closePrices.filter((_, index) => index % 3 === 0);

        shortEma = calculateEMA(threeMinuteData, 9).pop();
        longEma = calculateEMA(threeMinuteData, 49).pop();
    });
}

function startCalculations() {
    calculateBTCEMAs();
    calculateAll();
    if (intervalId !== null) clearInterval(intervalId);
    intervalId = setInterval(() => {
        calculateBTCEMAs();
        calculateAll();
    }, 120000); // Her 2 dakikada bir yenile
}

function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("resultTable");
    switching = true;
    dir = "asc"; // İlk başta yükseliş sıralaması
    while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];
            if (dir == "asc") {
                if (parseFloat(x.innerHTML) > parseFloat(y.innerHTML)) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir == "desc") {
                if (parseFloat(x.innerHTML) < parseFloat(y.innerHTML)) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
        } else {
            if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}
</script>
</body>
</html>
